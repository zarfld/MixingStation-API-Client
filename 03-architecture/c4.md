# C4 Architecture Diagrams

**Standard**: C4 Model (Simon Brown)  
**ISO/IEC/IEEE 42010:2011** Architecture Views  
**Phase**: 03 - Architecture  
**Date**: 2026-01-30  

## Overview

C4 (Context, Container, Component, Code) hierarchical views of the MixingStation API Client architecture for Phase 1 Epic 1.

---

## Level 1: System Context Diagram

**Audience**: Non-technical stakeholders  
**Purpose**: Show system-in-environment and external dependencies

```
┌─────────────────────────────────────────────────────────────────┐
│                        System Context                            │
└─────────────────────────────────────────────────────────────────┘

    ┌───────────┐                                  ┌──────────────┐
    │   User    │                                  │ MixingStation│
    │  (Audio   │                                  │   Console    │
    │ Engineer) │                                  │  (X32/M32)   │
    └─────┬─────┘                                  └──────┬───────┘
          │                                               │
          │ 1. Run exportlists CLI                       │ HTTP REST
          │ 2. View Excel files                          │ (Port 8045)
          │                                               │
          ▼                                               ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                                                               │
    │        MixingStation API Client (.NET 8 Library)             │
    │                                                               │
    │  - Connects to console via HTTP                              │
    │  - Reads mixer configuration                                 │
    │  - Normalizes data to CanonicalModel                         │
    │  - Exports to Excel (Input List + Patching)                  │
    │                                                               │
    └───────────────────────────────┬─────────────────────────────┘
                                    │
                                    │ Writes
                                    ▼
                            ┌──────────────┐
                            │ Excel Files  │
                            │ (.xlsx)      │
                            │              │
                            │ - InputList  │
                            │ - Patching   │
                            └──────────────┘
```

**Key Relationships**:
- **User → MixingStation API Client**: Invokes via CLI (`exportlists --ip 192.168.1.100`)
- **MixingStation API Client → MixingStation Console**: HTTP REST API (GET requests, JSON responses)
- **MixingStation API Client → Excel Files**: Writes .xlsx files to disk

---

## Level 2: Container Diagram

**Audience**: Technical stakeholders, architects  
**Purpose**: Show high-level technology choices and communication paths

```
┌─────────────────────────────────────────────────────────────────┐
│              MixingStation API Client (.NET 8)                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          CLI Container                           │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  exportlists.exe (Console App)                          │    │
│  │  - Parses CLI arguments (--ip, --output)                │    │
│  │  - Calls library: Connect → Read → Normalize → Export  │    │
│  │  - Exit codes: 0 (success), 1 (error)                  │    │
│  └──────────────────────┬─────────────────────────────────┘    │
│                         │                                        │
└─────────────────────────┼────────────────────────────────────────┘
                          │ References
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Library Containers                           │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  MixingStation.Client.dll (Class Library)               │    │
│  │  - IAppClient, IConsoleClient interfaces                │    │
│  │  - HttpClient-based REST API wrapper                    │    │
│  │  - DTOs (1:1 with OpenAPI schemas)                      │    │
│  │  - Public API mirrors REST paths                        │    │
│  └──────────────────────┬─────────────────────────────────┘    │
│                         │                                        │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  MixingStation.Normalizer.dll (Class Library)           │    │
│  │  - INormalizer interface                                │    │
│  │  - API responses → CanonicalModel transformation        │    │
│  │  - Handles "N/A" for missing data                       │    │
│  │  - Stereo pair detection logic                          │    │
│  └──────────────────────┬─────────────────────────────────┘    │
│                         │                                        │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  MixingStation.Workflows.dll (Class Library)            │    │
│  │  - IExcelExporter interface                             │    │
│  │  - EPPlus wrapper for Excel generation                  │    │
│  │  - Input List + Patching sheet formatting               │    │
│  └──────────────────────┬─────────────────────────────────┘    │
│                         │                                        │
└─────────────────────────┼────────────────────────────────────────┘
                          │ All reference
                          ▼
                  ┌────────────────┐
                  │ .NET 8 Runtime │
                  │ (CLR)          │
                  └────────────────┘

External Dependencies:
  - System.Net.Http (HttpClient, IHttpClientFactory)
  - System.Text.Json (JSON serialization)
  - EPPlus 7.x (Excel generation)
```

**Technology Choices**:
- **Runtime**: .NET 8 LTS (cross-platform)
- **HTTP**: System.Net.Http.HttpClient (no RestSharp/Flurl)
- **JSON**: System.Text.Json (camelCase naming)
- **Excel**: EPPlus 7.x (Polyform Noncommercial license)
- **DI**: Microsoft.Extensions.DependencyInjection

---

## Level 3: Component Diagram - MixingStation.Client

**Audience**: Developers  
**Purpose**: Show internal structure of REST client library

```
┌─────────────────────────────────────────────────────────────────┐
│              MixingStation.Client (Class Library)                │
└─────────────────────────────────────────────────────────────────┘

┌───────────────────┐         ┌───────────────────┐
│   IAppClient      │         │  IConsoleClient   │
│   (Interface)     │         │   (Interface)     │
├───────────────────┤         ├───────────────────┤
│ + GetMixersCurrentAsync()   │ + GetInformationAsync()
│ + ConnectAsync()  │         │ + GetDataAsync()  │
│ + DisconnectAsync()         │ + SetDataAsync()  │
│ + GetStatusAsync()│         │ + SubscribeAsync()│
└─────────┬─────────┘         └─────────┬─────────┘
          │                             │
          │ Implemented by              │ Implemented by
          ▼                             ▼
┌───────────────────┐         ┌───────────────────┐
│   AppClient       │         │  ConsoleClient    │
│   (Concrete)      │         │   (Concrete)      │
├───────────────────┤         ├───────────────────┤
│ - _httpClient     │         │ - _httpClient     │
│ - _options        │         │ - _options        │
└─────────┬─────────┘         └─────────┬─────────┘
          │                             │
          └──────────┬──────────────────┘
                     │
                     │ Uses
                     ▼
          ┌────────────────────┐
          │  HttpClient        │
          │  (via IHttpClient  │
          │   Factory)         │
          ├────────────────────┤
          │ - BaseAddress      │
          │ - Timeout (30s)    │
          │ - JsonSerializerOptions
          └─────────┬──────────┘
                    │
                    │ Calls
                    ▼
          ┌────────────────────┐
          │  MixingStation     │
          │  REST API          │
          │  (External)        │
          │                    │
          │  /app/*            │
          │  /console/*        │
          └────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        Models (DTOs)                             │
├─────────────────────────────────────────────────────────────────┤
│  MixerInfo, ConsoleInfo, ChannelConfig, ChannelValue, etc.      │
│  (1:1 mapping with OpenAPI schemas)                             │
└─────────────────────────────────────────────────────────────────┘
```

**Component Responsibilities**:

| Component | Responsibility | Pattern |
|-----------|---------------|---------|
| `IAppClient` | Define `/app/*` endpoint contracts | Interface |
| `IConsoleClient` | Define `/console/*` endpoint contracts | Interface |
| `AppClient` | Implement HTTP calls to `/app/*` | Adapter |
| `ConsoleClient` | Implement HTTP calls to `/console/*` | Adapter |
| DTOs (Models) | 1:1 with OpenAPI schemas | Data Transfer Object |

---

## Level 3: Component Diagram - MixingStation.Normalizer

**Audience**: Developers  
**Purpose**: Show normalization pipeline from API → CanonicalModel

```
┌─────────────────────────────────────────────────────────────────┐
│           MixingStation.Normalizer (Class Library)               │
└─────────────────────────────────────────────────────────────────┘

  ┌───────────────────┐
  │   INormalizer     │
  │   (Interface)     │
  ├───────────────────┤
  │ + NormalizeAsync(apiResponses) : CanonicalModel
  └─────────┬─────────┘
            │
            │ Implemented by
            ▼
  ┌───────────────────┐
  │  Normalizer       │
  │  (Concrete)       │
  ├───────────────────┤
  │ - MixerExtractor  │────┐
  │ - ChannelExtractor│    │ Uses
  │ - PatchExtractor  │    │
  └─────────┬─────────┘    │
            │              │
            │ Produces     │
            ▼              │
  ┌───────────────────┐    │
  │ CanonicalModel    │    │
  ├───────────────────┤    │
  │ + Mixer           │    │
  │ + Channels[]      │    │
  │ + Patches[]       │    │
  └───────────────────┘    │
                           │
  ┌────────────────────────┼────────────────────────┐
  │       Helper Classes   │                        │
  ├────────────────────────┼────────────────────────┤
  │  MixerExtractor        │  Extracts MixerInfo    │
  │  ChannelExtractor      │  Extracts ChannelInfo[]│
  │  PatchExtractor        │  Extracts PatchInfo[]  │
  │  StereoPairDetector    │  Identifies stereo links│
  │  ColorMapper           │  Maps API → hex colors │
  │  NAHandler             │  "N/A" for missing data│
  └────────────────────────┴────────────────────────┘
```

**Normalization Rules** (from ADR-003):
- Missing channel name → Default to "Ch {N}"
- Missing color → "N/A"
- Missing phantom/gain → "N/A"
- Stereo pairs detected via channel linking flags

---

## Level 3: Component Diagram - MixingStation.Workflows

**Audience**: Developers  
**Purpose**: Show Excel export pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│           MixingStation.Workflows (Class Library)                │
└─────────────────────────────────────────────────────────────────┘

  ┌───────────────────┐
  │  IExcelExporter   │
  │  (Interface)      │
  ├───────────────────┤
  │ + GenerateAsync(CanonicalModel) : byte[]
  │ + ExportToFileAsync(CanonicalModel, path)
  └─────────┬─────────┘
            │
            │ Implemented by
            ▼
  ┌───────────────────┐
  │  ExcelExporter    │
  │  (Concrete)       │
  ├───────────────────┤
  │ - _options        │
  │ - CreateWorkbook()│────┐
  │ - FormatHeader()  │    │ Uses
  │ - WriteInputList()│    │
  │ - WritePatchingList()  │
  └─────────┬─────────┘    │
            │              │
            │ Depends on   │
            ▼              │
  ┌───────────────────┐    │
  │    EPPlus         │    │
  │  (NuGet Package)  │◄───┘
  ├───────────────────┤
  │ ExcelPackage      │
  │ ExcelWorksheet    │
  │ ExcelRange        │
  └───────────────────┘
```

**Excel Export Components**:
- **IExcelExporter**: Interface for export strategies (future: CSV, Google Sheets)
- **ExcelExporter**: Concrete implementation using EPPlus
- **EPPlus**: Third-party library for .xlsx generation

---

## Cross-Cutting Concerns

### Dependency Injection

```csharp
// Startup configuration (CLI example)
services.AddHttpClient<IAppClient, AppClient>(client => {
    client.BaseAddress = new Uri("http://localhost:8045/");
    client.Timeout = TimeSpan.FromSeconds(30);
});

services.AddHttpClient<IConsoleClient, ConsoleClient>(client => {
    client.BaseAddress = new Uri("http://localhost:8045/");
});

services.AddSingleton<INormalizer, Normalizer>();
services.AddSingleton<IExcelExporter, ExcelExporter>();
```

### Error Handling Strategy

| Layer | Error Type | Handling |
|-------|-----------|----------|
| HTTP Client | `HttpRequestException` | Retry 3x with backoff, then throw custom `MixingStationException` |
| Normalizer | `JsonException`, null data | Map to `"N/A"` or default values (fail gracefully) |
| Exporter | `IOException` (disk full) | Bubble up with clear message |
| CLI | Any exception | Catch, log to stderr, exit code 1 |

### Logging

- **Library**: Microsoft.Extensions.Logging
- **Levels**: Debug (HTTP requests), Info (state changes), Warn (retries), Error (failures)
- **CLI**: Logs to console (stderr)

---

## Quality Attribute Scenarios (Mapped to Architecture)

| Scenario | Architecture Response |
|----------|---------------------|
| **Performance**: Export 64 channels in <5s | Batch API calls, parallel extraction, stream Excel generation |
| **Reliability**: Network timeout | IHttpClientFactory retry policy (3x, exponential backoff) |
| **Maintainability**: API endpoint rename | Public method name matches REST (CI enforces), only 1 place to change |
| **Testability**: Unit test `Normalizer` | Inject mock `IAppClient`, test transformation logic in isolation |
| **Extensibility**: Add CSV export | Implement `IExporter` interface, register in DI |

---

## Traceability to Requirements

| Component | Implements | Verified By |
|-----------|-----------|-------------|
| `AppClient` | REQ-F-001, REQ-F-002 | TEST-001 (Unit tests) |
| `ConsoleClient` | REQ-F-001, REQ-F-003 | TEST-002 (Integration tests) |
| `Normalizer` | REQ-F-004 | TEST-003 (Transformation tests) |
| `ExcelExporter` | REQ-F-005 | TEST-004 (Export format tests) |
| `exportlists` CLI | REQ-F-006 | TEST-005 (End-to-end acceptance test) |

---

## Next Steps

- **Phase 04**: Detailed design (class diagrams, sequence diagrams for key flows)
- **Phase 05**: Implementation with TDD (Red-Green-Refactor)
- **Phase 07**: Verification & validation (create TEST issues, run acceptance tests)

---

**Compliance**: ISO/IEC/IEEE 42010:2011 (Architecture description with multiple views)
