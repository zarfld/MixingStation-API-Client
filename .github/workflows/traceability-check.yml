name: Traceability Validation

# üéØ LIGHTWEIGHT TRACEABILITY VALIDATION (2-3 min)
# Complements ci-standards-compliance.yml with fast, focused traceability checks
#
# üìã Purpose:
#   - Fast feedback on PRs: Posts traceability summary comment
#   - Issue validation: Checks traceability links when issues are created/edited
#   - Early detection: Catches missing links before full CI runs
#   - Reduced feedback loop: Quick validation without running tests
#
# üîÑ Workflow Strategy:
#   1. This workflow: Fast traceability validation (on issue/PR events)
#   2. ci-standards-compliance.yml: Full CI/CD with tests (on push/PR events)
#   
#   Both workflows run on PRs:
#   - This workflow: Quick traceability check + PR comment
#   - Full CI: Complete validation with matrix testing
#
# ‚ö° Triggers:
#   - Pull requests: opened, synchronized, reopened
#   - Issues: opened, edited (validates links immediately)
#   - Manual: workflow_dispatch
#
# üìä For comprehensive CI/CD (tests, security, compliance):
#   ‚Üí See .github/workflows/ci-standards-compliance.yml

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-traceability:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt || pip install PyGithub requests pyyaml
      
      - name: Generate traceability.json from GitHub Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          mkdir -p build
          echo "üìä Generating traceability.json from GitHub Issues..."
          python scripts/github-issues-to-traceability-json.py || {
            echo "‚ö†Ô∏è Traceability generation needs GitHub Issues to be created first"
            echo '{"source": "github-issues", "items": [], "metrics": {}}' > build/traceability.json
          }
        continue-on-error: true
      
      - name: Check for unlinked requirements (ADR linkage)
        run: |
          echo "üîç Checking for requirements without ADR links..."
          python scripts/trace_unlinked_requirements.py --markdown || {
            echo "‚ö†Ô∏è Unlinked requirements check needs traceability.json"
            exit 0
          }
        continue-on-error: true
      
      - name: Check for orphaned requirements
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/github-orphan-check.py || {
            echo "\u26a0\ufe0f Orphan check needs GitHub Issues to be created first"
            echo "See docs/QUICK-START-github-issues.md for issue creation workflow"
            exit 0
          }
        continue-on-error: true
        id: orphan-check
      
      - name: Generate traceability report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p reports
          python scripts/github-traceability-report.py > reports/github-traceability.md || {
            echo "# Traceability Report" > reports/github-traceability.md
            echo "" >> reports/github-traceability.md
            echo "## Status: GitHub Issues Setup Required" >> reports/github-traceability.md
            echo "" >> reports/github-traceability.md
            echo "Traceability tracking via GitHub Issues is configured but no issues exist yet." >> reports/github-traceability.md
            echo "" >> reports/github-traceability.md
            echo "Next Steps:" >> reports/github-traceability.md
            echo "1. Create issues using templates in .github/ISSUE_TEMPLATE/" >> reports/github-traceability.md
            echo "2. Link issues using 'Traces to: #N' syntax" >> reports/github-traceability.md
            echo "3. See docs/QUICK-START-github-issues.md for guidance" >> reports/github-traceability.md
          }
      
      - name: Validate traceability matrix completeness
        run: |
          echo "‚úÖ Validating traceability matrix..."
          python scripts/validate-traceability.py || {
            echo "‚ö†Ô∏è Validation needs reports to be generated first"
            exit 0
          }
        continue-on-error: true
      
      - name: Upload traceability artifacts
        uses: actions/upload-artifact@v4
        with:
          name: traceability-artifacts
          path: |
            build/traceability.json
            reports/github-traceability.md
            reports/orphan-check.log
          retention-days: 30
      
      - name: Upload traceability report
        uses: actions/upload-artifact@v4
        with:
          name: traceability-report
          path: reports/github-traceability.md
          retention-days: 30
      
      - name: Comment on PR with report summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/github-traceability.md', 'utf8');
            
            // Extract summary section
            const summaryMatch = report.match(/## Summary\n([\s\S]*?)##/);
            const summary = summaryMatch ? summaryMatch[1] : 'Summary not available';
            
            const comment = `## üìä Traceability Report
            
            ${summary}
            
            üìé Full report available in workflow artifacts.
            
            [View detailed traceability matrix](../actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Check orphan results
        if: steps.orphan-check.outcome == 'failure'
        run: |
          echo "‚ùå Orphaned requirements detected!"
          echo "Please link all requirements to parent issues."
          exit 1
